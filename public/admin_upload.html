<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Aggiornamento Dati</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 45px -12px rgba(0, 0, 0, 0.4);
            text-align: center;
        }
        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        p {
            color: #94a3b8;
            margin-bottom: 2rem;
        }
        .btn {
            padding: 0.875rem 2rem;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px -5px rgba(99, 102, 241, 0.6);
        }
        .hidden { display: none; }
        #feedback {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            text-align: left;
            line-height: 1.6;
            font-size: 0.9rem;
            color: #cbd5e1;
        }
        code {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fas fa-cogs"></i> Pannello Admin</h1>

        <!-- Schermata di Login -->
        <div id="login-screen">
            <p>Accedi per gestire i dati del database.</p>
            <button id="login-btn" class="btn">
                <i class="fab fa-google"></i> Accedi con Google
            </button>
            <div id="login-feedback" class="hidden" style="margin-top: 1rem; color: #f87171;"></div>
        </div>

        <!-- Schermata di Upload (visibile dopo il login) -->
        <div id="upload-screen" class="hidden">
            <p>Carica un file CSV per aggiornare il campo <code>fibers</code> degli alimenti. <br> Intestazioni richieste: <code>Alimento</code> e <code>Fibra totale (g)</code>.</p>
            <input type="file" id="csv-file-input" class="hidden" accept=".csv, text/csv">
            <button id="upload-csv-btn" class="btn">
                <i class="fas fa-upload"></i> Carica e Aggiorna
            </button>
            <div id="feedback" class="hidden"></div>
        </div>
    </div>

    <script type="module">
        // Importa le funzioni necessarie da Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 1. INCOLLA QUI LA TUA CONFIGURAZIONE FIREBASE da firebase-config.js ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCwhGg3hSQauEXmA1YKMgH60JQk9VNvXA",
            authDomain: "diario-alimentare-4f07f.firebaseapp.com",
            projectId: "diario-alimentare-4f07f",
            storageBucket: "diario-alimentare-4f07f.appspot.com",
            messagingSenderId: "904900489529",
            appId: "1:904900489529:web:bb8d121f2a9a206c1538e8",
            measurementId: "G-JYDET1ZW5K"
        };

        // Controllo di sicurezza per la configurazione
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "...") {
            document.body.innerHTML = `
                <div class="container" style="border-color: #ef4444;">
                    <h1 style="color: #f87171;"><i class="fas fa-exclamation-triangle"></i> Errore di Configurazione</h1>
                    <p style="color: #fca5a5;">La configurazione di Firebase non è stata inserita in <code>admin_upload.html</code>.</p>
                    <p>Apri il file <code>public/firebase-config.js</code>, copia la costante <code>firebaseConfig</code> e incollala in questo file (<code>admin_upload.html</code>) al posto del segnaposto.</p>
                </div>
            `;
            // Blocca l'esecuzione dello script per prevenire altri errori
            throw new Error("Configurazione Firebase mancante o incompleta in admin_upload.html. Controlla il messaggio a schermo.");
        }

        // Inizializzazione
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginScreen = document.getElementById('login-screen');
        const uploadScreen = document.getElementById('upload-screen');
        const loginBtn = document.getElementById('login-btn');
        const uploadBtn = document.getElementById('upload-csv-btn');
        const fileInput = document.getElementById('csv-file-input');
        const loginFeedbackEl = document.getElementById('login-feedback');
        const feedbackEl = document.getElementById('feedback');

        // Gestione autenticazione
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('hidden');
                uploadScreen.classList.remove('hidden');
            } else {
                loginScreen.classList.remove('hidden');
                uploadScreen.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            loginFeedbackEl.classList.add('hidden');
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Errore login:", error);
                loginFeedbackEl.textContent = `Errore di login: ${error.message}. Hai incollato la configurazione corretta?`;
                loginFeedbackEl.classList.remove('hidden');
            }
        });

        // Logica di Upload
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleCsvUpload);

        async function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            feedbackEl.classList.remove('hidden');
            feedbackEl.innerHTML = 'Inizio elaborazione file...';

            const text = await file.text();
            const rows = text.split('\n').map(row => row.trim()).filter(Boolean);

            if (rows.length <= 1) {
                feedbackEl.textContent = 'Errore: File CSV vuoto o con solo l\'intestazione.';
                return;
            }

            const header = rows[0].split(';').map(h => h.trim());
            const nameIndex = header.indexOf('Alimento');
            const fiberIndex = header.indexOf('Fibra totale (g)');

            if (nameIndex === -1 || fiberIndex === -1) {
                feedbackEl.textContent = 'Errore: Intestazioni CSV non valide. Assicurati che ci siano "Alimento" e "Fibra totale (g)".';
                return;
            }

            const dataToUpdate = rows.slice(1).map(row => {
                const columns = row.split(';');
                const name = columns[nameIndex]?.trim();
                const fibers = parseFloat(columns[fiberIndex]?.trim().replace(',', '.'));
                if (name && !isNaN(fibers)) return { name, fibers };
                return null;
            }).filter(Boolean);

            feedbackEl.innerHTML = `Trovati ${dataToUpdate.length} alimenti. Inizio aggiornamento... Questo potrebbe richiedere tempo.`;

            let updatedCount = 0, notFoundCount = 0;
            const foodsCollection = collection(db, 'foods');
            const chunkSize = 50; // Processa 50 righe alla volta per evitare sovraccarichi

            for (let i = 0; i < dataToUpdate.length; i += chunkSize) {
                const chunk = dataToUpdate.slice(i, i + chunkSize);
                const promises = chunk.map(async (item) => {
                    const q = query(foodsCollection, where('name_lowercase', '==', item.name.toLowerCase()), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const docToUpdate = querySnapshot.docs[0];
                        await setDoc(docToUpdate.ref, { fibers: item.fibers }, { merge: true });
                        updatedCount++;
                    } else {
                        notFoundCount++;
                    }
                });
                
                await Promise.all(promises);
                feedbackEl.innerHTML = `Elaborati ${i + chunk.length} / ${dataToUpdate.length} (Aggiornati: ${updatedCount}, Non trovati: ${notFoundCount})`;
            }

            let finalMessage = `✨ Processo completato! <br>Aggiornati: ${updatedCount} | Non trovati: ${notFoundCount}`;
            feedbackEl.innerHTML = finalMessage;
            event.target.value = ''; // Permette di ricaricare lo stesso file
        }
    </script>
</body>
</html>